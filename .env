from google.adk import Agent
from google.adk.agents import ParallelAgent, SequentialAgent, LlmAgent
from google.adk.tools import AgentTool
from typing import Optional, List
from pydantic import BaseModel
from enum import Enum
import os

from Agents.CustomTools.pdf_reader_tool import PdfReaderTool
from Agents.CustomTools.vertex_search_tool import VertexSearchTool

# ----------------------------
# Agent Type Enum
# ----------------------------
class AgentType(str, Enum):
    VERTEX_AI_SEARCH = "Vertex AI Search"
    DISPATCH = "Dispatch"
    EVALUATOR = "Evaluator"
    ORCHESTRATOR = "Orchestrator"
    SUMMARIZATION = "Summarization"

# ----------------------------
# Agent Config
# ----------------------------
class AgentConfig(BaseModel):
    name: str
    model: str
    instruction: Optional[str] = None
    description: Optional[str] = None
    agent_type: AgentType
    data_store_id: Optional[str] = None
    project: str = os.getenv("PROJECT_ID")
    location: Optional[str] = "global"
    pdf_path: Optional[str] = None
    sub_agents: Optional[List[str]] = None
    agent_dependencies: Optional[List[Agent]] = None

    class Config:
        use_enum_values = True
        arbitrary_types_allowed = True

# ----------------------------
# Agent Factory
# ----------------------------
class AgentFactory:
    def __init__(self, configs: List[dict]):
        self.configs = [AgentConfig(**c) for c in configs]

    def build_graph(self):
        graph = {}

        for agent in self.configs:
            dependencies = []
            if agent.sub_agents:
                for sub_name in agent.sub_agents:
                    if sub_name not in graph:
                        raise ValueError(f"Sub-agent '{sub_name}' not found")
                    dependencies.append(graph[sub_name])
            agent.agent_dependencies = dependencies

            # -------------------
            # Create agents
            # -------------------
            if agent.agent_type == AgentType.VERTEX_AI_SEARCH:
                tools = []

                # Add PDF Reader tool if pdf_path exists
                if agent.pdf_path:
                    tools.append(PdfReaderTool(pdf_path=agent.pdf_path))

                # Add Vertex AI Search
                tools.append(VertexSearchTool(
                    project=agent.project,
                    location=agent.location,
                    datastore=agent.data_store_id
                ))

                graph[agent.name] = Agent(
                    name=agent.name,
                    model=agent.model,
                    instruction=agent.instruction,
                    description=agent.description,
                    tools=tools
                )

            elif agent.agent_type == AgentType.DISPATCH:
                graph[agent.name] = ParallelAgent(
                    name=agent.name,
                    description=agent.description,
                    sub_agent=agent.agent_dependencies
                )

            elif agent.agent_type == AgentType.EVALUATOR:
                graph[agent.name] = Agent(
                    name=agent.name,
                    model=agent.model,
                    instruction=agent.instruction,
                    description=agent.description
                )

            elif agent.agent_type == AgentType.ORCHESTRATOR:
                graph[agent.name] = SequentialAgent(
                    name=agent.name,
                    description=agent.description,
                    tools=[VertexSearchTool(
                        project=agent.project,
                        location=agent.location,
                        datastore=agent.data_store_id
                    )],
                    sub_agent=agent.agent_dependencies
                )

            elif agent.agent_type == AgentType.SUMMARIZATION:
                graph[agent.name] = ParallelAgent(
                    name=agent.name,
                    model=agent.model,
                    instruction=agent.instruction,
                    description=agent.description
                )

        # Return the root orchestrator if exists, else first agent
        if "orchestrator_agent" in graph:
            return graph["orchestrator_agent"]
        return next(iter(graph.values()))
